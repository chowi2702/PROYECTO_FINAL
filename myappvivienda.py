# -*- coding: utf-8 -*-
"""myAppVivienda.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1UQUASSjw8hUJKye6IFlfF97I43-FAhHH

# Pipes - Despliegue

- Cargamos el modelo
- Cargamos los datos futuros
- Aplicar tubería
"""

#Cargamos librerías principales
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

# Función para eliminar atípicos (similar a la profesora)
def limpiar_atipicos(X):
    """
    Limpia valores atípicos reemplazándolos con np.nan
    """
    # Limpiar LotFrontage (valores >= 270)
    X.loc[X["LotFrontage"] >= 270, "LotFrontage"] = np.nan

    # Limpiar TotalBsmtSF (valores > 5500)
    X.loc[X["TotalBsmtSF"] > 5500, "TotalBsmtSF"] = np.nan

    # Limpiar BsmtFinSF1 (valores > 5500)
    X.loc[X["BsmtFinSF1"] > 5500, "BsmtFinSF1"] = np.nan

    return X

print('Función de limpieza de atípicos definida')

import pickle
with open('pipeline_final.pkl', 'rb') as f:
    pipeline_final = pickle.load(f)

pipeline_final

#Cargamos los datos futuros
#data = pd.read_csv("/content/housing_sample.csv")
#data.head()

#Añadir las columnas de categoría de año (necesarias para el pipeline)
if 'YearBuilt_Category' not in data.columns:
    data['YearBuilt_Category'] = pd.cut(
        data['YearBuilt'],
        bins=[1872, 1920, 1950, 1980, 2010],
        labels=["1872-1920", "1921-1950", "1951-1980", "1981-2010"],
        right=True,
        include_lowest=True
    )

if 'YearRemodAdd_Category' not in data.columns:
    data['YearRemodAdd_Category'] = pd.cut(
        data['YearRemodAdd'],
        bins=[1950, 1980, 2010],
        labels=["1950-1980", "1981-2010"],
        right=True,
        include_lowest=True
    )

import streamlit as st

st.set_page_config(page_title="Predicción de precios de casas", layout="wide")
st.title('Predicción de precio de una casa')

# Opciones más frecuentes según el dataset Ames Housing
MSZoning_opts = ['RL', 'RM', 'C (all)', 'FV', 'RH']
Street_opts = ['Pave', 'Grvl']
Alley_opts = ['NA', 'Pave', 'Grvl']
LotShape_opts = ['Reg', 'IR1', 'IR2', 'IR3']
LandContour_opts = ['Lvl', 'Bnk', 'HLS', 'Low']
Utilities_opts = ['AllPub', 'NoSewr', 'NoSeWa', 'ELO']
LotConfig_opts = ['Inside', 'Corner', 'CulDSac', 'FR2', 'FR3']
LandSlope_opts = ['Gtl', 'Mod', 'Sev']
Neighborhood_opts = [
    'CollgCr', 'Veenker', 'Crawfor', 'NoRidge', 'Mitchel', 'Somerst', 'NWAmes', 'OldTown',
    'BrkSide', 'Sawyer', 'NridgHt', 'NAmes', 'SawyerW', 'IDOTRR', 'MeadowV', 'Edwards',
    'Timber', 'Gilbert', 'StoneBr', 'ClearCr', 'NPkVill', 'Blmngtn', 'BrDale', 'SWISU', 'Northridge'
]
Condition_opts = ['Norm', 'Feedr', 'Artery', 'RRNn', 'RRAn', 'PosN', 'PosA', 'RRNe', 'RRAe']
BldgType_opts = ['1Fam', '2fmCon', 'Duplex', 'Twnhs', 'TwnhsE']
HouseStyle_opts = ['1Story', '2Story', '1.5Fin', '1.5Unf', 'SFoyer', 'SLvl', '2.5Fin', '2.5Unf']
RoofStyle_opts = ['Gable', 'Hip', 'Gambrel', 'Flat', 'Mansard', 'Shed']
RoofMatl_opts = ['CompShg','WdShngl','Metal','WdShake','Membran','Tar&Grv','Roll','ClyTile']
Exterior1st_opts = ['VinylSd','MetalSd','Wd Sdng','HdBoard','BrkFace','Plywood','CemntBd','WdShing','AsbShng','Stucco','BrkComm','Other','Stone','ImStucc','CBlock']
Exterior2nd_opts = Exterior1st_opts + ['AsphShn','SheetMetal']
MasVnrType_opts = ['None','BrkFace','Stone','BrkCmn']
ExterQual_opts = ['TA','Gd','Ex','Fa']
ExterCond_opts = ['TA','Gd','Ex','Fa','Po']
Foundation_opts = ['PConc','CBlock','BrkTil','Slab','Stone','Wood']
BsmtQual_opts = ['TA','Gd','Fa','Ex','NA']
BsmtCond_opts = ['TA','Gd','Fa','Po','NA']
BsmtExposure_opts = ['No','Gd','Mn','Av','NA']
BsmtFinType_opts = ['Unf','Rec','ALQ','BLQ','GLQ','LwQ','NA']
Heating_opts = ['GasA','GasW','Grav','Wall','OthW','Floor']
HeatingQC_opts = ['Ex','Gd','TA','Fa','Po']
CentralAir_opts = ['Y','N']
Electrical_opts = ['SBrkr','FuseA','FuseF','FuseP','Mix']
KitchenQual_opts = ['TA','Gd','Ex','Fa']
Functional_opts = ['Typ','Min1','Min2','Mod','Maj1','Maj2','Sev']
FireplaceQu_opts = ['NA','TA','Gd','Ex','Fa','Po']
GarageType_opts = ['NA','Attchd','Detchd','BuiltIn','CarPort','Basment','2Types']
GarageFinish_opts = ['NA','Unf','RFn','Fin']
GarageQual_opts = ['TA','Fa','Gd','Ex','Po','NA']
GarageCond_opts = ['TA','Fa','Gd','Po','Ex','NA']
PavedDrive_opts = ['Y','N','P']
PoolQC_opts = ['NA','Ex','Fa','Gd']
Fence_opts = ['NA','GdPrv','MnPrv','GdWo','MnWw']
MiscFeature_opts = ['NA','Shed','Gar2','Othr','TenC']
SaleType_opts = ['WD','CWD','VWD','COD','Con','ConLw','ConLI','ConLD','Oth','New']
SaleCondition_opts = ['Normal','Abnorml','AdjLand','Alloca','Family','Partial']

entrada = {
    'MSSubClass': st.number_input('MSSubClass', min_value=1, max_value=200, value=20),
    'MSZoning': st.selectbox('MSZoning', MSZoning_opts),
    'LotFrontage': st.number_input('LotFrontage', min_value=0, max_value=300, value=60),
    'LotArea': st.number_input('LotArea', min_value=0, max_value=100000, value=8450),
    'Street': st.selectbox('Street', Street_opts),
    'Alley': st.selectbox('Alley', Alley_opts),
    'LotShape': st.selectbox('LotShape', LotShape_opts),
    'LandContour': st.selectbox('LandContour', LandContour_opts),
    'Utilities': st.selectbox('Utilities', Utilities_opts),
    'LotConfig': st.selectbox('LotConfig', LotConfig_opts),
    'LandSlope': st.selectbox('LandSlope', LandSlope_opts),
    'Neighborhood': st.selectbox('Neighborhood', Neighborhood_opts),
    'Condition1': st.selectbox('Condition1', Condition_opts),
    'Condition2': st.selectbox('Condition2', Condition_opts),
    'BldgType': st.selectbox('BldgType', BldgType_opts),
    'HouseStyle': st.selectbox('HouseStyle', HouseStyle_opts),
    'OverallQual': st.slider('OverallQual', min_value=1, max_value=10, value=7),
    'OverallCond': st.slider('OverallCond', min_value=1, max_value=10, value=5),
    'YearBuilt': st.number_input('YearBuilt', min_value=1800, max_value=2025, value=2008),
    'YearRemodAdd': st.number_input('YearRemodAdd', min_value=1800, max_value=2025, value=2008),
    'RoofStyle': st.selectbox('RoofStyle', RoofStyle_opts),
    'RoofMatl': st.selectbox('RoofMatl', RoofMatl_opts),
    'Exterior1st': st.selectbox('Exterior1st', Exterior1st_opts),
    'Exterior2nd': st.selectbox('Exterior2nd', Exterior2nd_opts),
    'MasVnrType': st.selectbox('MasVnrType', MasVnrType_opts),
    'MasVnrArea': st.number_input('MasVnrArea', min_value=0, max_value=1500, value=0),
    'ExterQual': st.selectbox('ExterQual', ExterQual_opts),
    'ExterCond': st.selectbox('ExterCond', ExterCond_opts),
    'Foundation': st.selectbox('Foundation', Foundation_opts),
    'BsmtQual': st.selectbox('BsmtQual', BsmtQual_opts),
    'BsmtCond': st.selectbox('BsmtCond', BsmtCond_opts),
    'BsmtExposure': st.selectbox('BsmtExposure', BsmtExposure_opts),
    'BsmtFinType1': st.selectbox('BsmtFinType1', BsmtFinType_opts),
    'BsmtFinSF1': st.number_input('BsmtFinSF1', min_value=0, max_value=3000, value=0),
    'BsmtFinType2': st.selectbox('BsmtFinType2', BsmtFinType_opts),
    'BsmtFinSF2': st.number_input('BsmtFinSF2', min_value=0, max_value=2000, value=0),
    'BsmtUnfSF': st.number_input('BsmtUnfSF', min_value=0, max_value=3000, value=0),
    'TotalBsmtSF': st.number_input('TotalBsmtSF', min_value=0, max_value=7000, value=0),
    'Heating': st.selectbox('Heating', Heating_opts),
    'HeatingQC': st.selectbox('HeatingQC', HeatingQC_opts),
    'CentralAir': st.selectbox('CentralAir', CentralAir_opts),
    'Electrical': st.selectbox('Electrical', Electrical_opts),
    '1stFlrSF': st.number_input('1stFlrSF', min_value=0, max_value=3000, value=0),
    '2ndFlrSF': st.number_input('2ndFlrSF', min_value=0, max_value=2000, value=0),
    'LowQualFinSF': st.number_input('LowQualFinSF', min_value=0, max_value=2000, value=0),
    'GrLivArea': st.number_input('GrLivArea', min_value=0, max_value=7000, value=0),
    'BsmtFullBath': st.slider('BsmtFullBath', min_value=0, max_value=3, value=0),
    'BsmtHalfBath': st.slider('BsmtHalfBath', min_value=0, max_value=2, value=0),
    'FullBath': st.slider('FullBath', min_value=0, max_value=3, value=1),
    'HalfBath': st.slider('HalfBath', min_value=0, max_value=2, value=0),
    'BedroomAbvGr': st.slider('BedroomAbvGr', min_value=0, max_value=8, value=3),
    'KitchenAbvGr': st.slider('KitchenAbvGr', min_value=0, max_value=5, value=1),
    'KitchenQual': st.selectbox('KitchenQual', KitchenQual_opts),
    'TotRmsAbvGrd': st.slider('TotRmsAbvGrd', min_value=0, max_value=20, value=7),
    'Functional': st.selectbox('Functional', Functional_opts),
    'Fireplaces': st.slider('Fireplaces', min_value=0, max_value=4, value=0),
    'FireplaceQu': st.selectbox('FireplaceQu', FireplaceQu_opts),
    'GarageType': st.selectbox('GarageType', GarageType_opts),
    'GarageYrBlt': st.number_input('GarageYrBlt', min_value=1800, max_value=2025, value=1800),
    'GarageFinish': st.selectbox('GarageFinish', GarageFinish_opts),
    'GarageCars': st.slider('GarageCars', min_value=0, max_value=5, value=2),
    'GarageArea': st.number_input('GarageArea', min_value=0, max_value=1500, value=0),
    'GarageQual': st.selectbox('GarageQual', GarageQual_opts),
    'GarageCond': st.selectbox('GarageCond', GarageCond_opts),
    'PavedDrive': st.selectbox('PavedDrive', PavedDrive_opts),
    'WoodDeckSF': st.number_input('WoodDeckSF', min_value=0, max_value=1000, value=0),
    'OpenPorchSF': st.number_input('OpenPorchSF', min_value=0, max_value=1000, value=0),
    'EnclosedPorch': st.number_input('EnclosedPorch', min_value=0, max_value=1000, value=0),
    '3SsnPorch': st.number_input('3SsnPorch', min_value=0, max_value=1000, value=0),
    'ScreenPorch': st.number_input('ScreenPorch', min_value=0, max_value=1000, value=0),
    'PoolArea': st.number_input('PoolArea', min_value=0, max_value=1000, value=0),
    'PoolQC': st.selectbox('PoolQC', PoolQC_opts),
    'Fence': st.selectbox('Fence', Fence_opts),
    'MiscFeature': st.selectbox('MiscFeature', MiscFeature_opts),
    'MiscVal': st.number_input('MiscVal', min_value=0, max_value=40000, value=0),
    'MoSold': st.slider('MoSold', min_value=1, max_value=12, value=6),
    'YrSold': st.number_input('YrSold', min_value=1990, max_value=2025, value=2010),
    'SaleType': st.selectbox('SaleType', SaleType_opts),
    'SaleCondition': st.selectbox('SaleCondition', SaleCondition_opts)
}

# Botón para predecir
if st.button('Predecir precio'):
    data = pd.DataFrame([entrada])
    # Añadir columnas derivadas
    data['YearBuilt_Category'] = pd.cut(
        data['YearBuilt'],
        bins=[1872, 1920, 1950, 1980, 2010],
        labels=["1872-1920", "1921-1950", "1951-1980", "1981-2010"],
        right=True,
        include_lowest=True
    )
    data['YearRemodAdd_Category'] = pd.cut(
        data['YearRemodAdd'],
        bins=[1950, 1980, 2010],
        labels=["1950-1980", "1981-2010"],
        right=True,
        include_lowest=True
    )
    
    pred = pipeline_final.predict(data)
    st.success(f"El precio estimado de la casa es: ${pred[0]:,.2f}")
    st.write("Datos ingresados:")
    st.dataframe(data)

#Hacemos la predicción con el Tree
Y_rf = pipeline_final.predict(data)
print(Y_rf)

#data['Prediccion']=Y_rf
#data
